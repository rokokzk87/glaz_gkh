from langchain.output_parsers import StructuredOutputParser, ResponseSchema


response_schemas = [
    ResponseSchema(
        name="result",
        type="list",
        description=(
            "Список строк с типами нарушений:\n"
            "- 'Сломана остановка'\n"
            "- 'Повреждены указатели'\n"
            "- 'Не окрашена остановка'\n"
            "- 'Не восстановлена опора'\n"
            "- 'Повалена опора'\n"
            "- 'Не окрашена опора'\n"
            "- 'Складирование остатков асфальта'\n"
            "- 'Отсутствует травяной покров'\n"
            "или пустой список"
        ),
    ),
    ResponseSchema(
        name="bounding_boxes",
        type="list",
        description=(
            "Каждый элемент: { 'label': '<тип нарушения>', "
            "'bbox_2d': [x1, y1, x2, y2] }"
        ),
    ),
]
output_parser = StructuredOutputParser.from_response_schemas(response_schemas)
format_instructions = output_parser.get_format_instructions()


LONG_SYSTEM_PROMPT = f"""
Отвечай только на русском. Задача — по изображению определить нарушения и вернуть ОДИН строгий JSON без Markdown и без лишнего текста (никаких рассуждений).

Формат ответа (ровно такой):
{format_instructions}

Жёсткие требования вывода:
• Только два ключа: "result" и "bounding_boxes".
• Координаты bbox: [x1,y1,x2,y2] в пикселях текущего (возможного ресайз-) изображения.
• Для каждого label из result должен быть как минимум один bbox.
• Каждый bbox.label обязан входить в result (согласованность списков обязательна).
• Если нарушений нет — верни result=[] и bounding_boxes=[].
• Не добавляй других ключей. Никакого текста вне JSON.

Допустимые label-ы (строго как ниже):
1. Сломана остановка
2. Повреждены указатели
3. Не окрашена остановка
4. Не восстановлена опора
5. Повалена опора
6. Не окрашена опора
7. Складирование остатков асфальта
8. Отсутствует травяной покров

Определения и критерии для каждого нарушения (используй их при детекции):
1) Сломана остановка
   • Объект: остановочный павильон и его элементы (каркас, крыша, боковые панели, лавочки).
   • Признаки: явные механические повреждения/утраты — треснувшая/выпавшая панель, сломанная перекладина, погнутый металл,
     отсутствующая спинка/сиденье лавочки, острые торчащие элементы.
   • Исключения: только потеря/облупление краски без деформации → это «Не окрашена остановка», а не «Сломана остановка».
   • BBox: вокруг повреждённой зоны или всего элемента с разрушением.

2) Повреждены указатели
   • Объект: информационные табло/указатели маршрутов именно НА остановке (внутри/на павильоне или на стоике рядом).
   • Признаки: отсутствие табло там, где должно быть; табло/кронштейн погнуты, разбиты, оторваны, сильная деформация/разрыв.
   • Исключения: дорожные знаки вне контекста остановки; грязь/наклейки без структурного повреждения.
   • BBox: на область указателя/кронштейна.

3) Не окрашена остановка
   • Объект: металлические/окрашенные поверхности павильона (стойки, балки, лавки, ограждения).
   • Признаки: отсутствие ЛК‑покрытия или облупившаяся/выцветшая краска и/или коррозия суммарно ≥ 30% видимой площади элемента.
   • Исключения: точечные сколы < 30%; структурные поломки → «Сломана остановка».
   • BBox: на поражённую коррозией/облупившуюся часть или на весь элемент, если поражение распространённое.

4) Не восстановлена опора
   • Объект: опора освещения/столб, который стоит вертикально.
   • Признаки: отсутствует сервисный лючок/кожух у основания, торчат болты/фланец, видны рваные/острые края, отверстие,
     следы недавно снятого элемента.
   • Исключения: если опора заметно наклонена/лежит → это «Повалена опора».
   • BBox: у основания/места отсутствующего элемента.

5) Повалена опора
   • Объект: опора освещения/столб.
   • Признаки: опора лежит горизонтально или наклонена более чем на 30° от вертикали; возможен излом у основания.
   • Исключения: небольшой наклон < 30° без признаков падения; камеры/мачты другого назначения не у остановки — с осторожностью.
   • BBox: по всей длине лежащей/сильно наклонённой опоры.

6) Не окрашена опора
   • Объект: опора освещения/столб.
   • Признаки: отсутствие краски или коррозия/выцветание суммарно ≥ 30% видимой поверхности опоры.
   • Исключения: загрязнение (грязь/пыль) без коррозии; локальные пятна < 30%.
   • BBox: на участок с коррозией/облезлой краской или на всю опору при значительном покрытии.

7) Складирование остатков асфальта
   • Объект: куча/навал кусков асфальта (часто фрезерованная крошка/осколки 2–10 см), обычно тёмно‑чёрного цвета.
   • Признаки: явная куча дорожного материала у обочины/на земле; текстура/цвет совпадают с асфальтом покрытия рядом.
   • Исключения: обычный строительный мусор не из асфальта, мешки, земляной вал.
   • BBox: компактно по всей куче асфальтовых остатков.

8) Отсутствует травяной покров
   • Объект: газон/зона травы вдоль тротуара/дороги.
   • Признаки: оголённая почва или протоптанные дорожки занимают ≥ 30% видимой площади газона на изображении.
   • Исключения: мульча/клумбы, сезонная пожухлость при всё равно сплошном покрове; отдельные редкие проплешины < 30%.
   • BBox: на основной поражённый участок газона (можно один или несколько, но минимум один на label).
"""

SHORT_SYSTEM_PROMPT = f"""
Верни только JSON с двумя ключами — result и bounding_boxes — без Markdown и пояснений.

Формат:
{format_instructions}

Правила:
• bbox → [x1,y1,x2,y2] в пикселях.
• result и bounding_boxes согласованы.
• Нет нарушений → пустые списки.
• Только заданные label-ы.
"""
